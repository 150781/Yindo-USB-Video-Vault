name: ğŸš€ Build & Security Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  # ================================
  # ğŸ” Security & Code Quality
  # ================================
  security-audit:
    name: ğŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Security Audit
      run: npm audit --audit-level moderate
      
    - name: ğŸ” Security Gates (Crypto APIs)
      run: |
        echo "ğŸ” Checking for deprecated crypto APIs..."
        ! grep -r "crypto\.createCipher\|crypto\.createDecipher\|md5\|sha1" src/ || exit 1
        echo "âœ… No deprecated crypto APIs found"
        
    - name: ğŸš« Clear Text Detection
      run: |
        echo "ğŸ” Checking for clear MP4 writes..."
        ! grep -r "\.mp4.*write\|write.*\.mp4" src/ || exit 1
        echo "âœ… No clear MP4 writes detected"

  # ================================
  # ğŸ§ª TypeScript & Tests
  # ================================
  typescript-validation:
    name: ğŸ“ TypeScript Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ”§ TypeScript Check
      run: npm run typecheck
      
    - name: ğŸ§ª Unit Tests
      run: npm test
      
    - name: ğŸ¯ Test Coverage
      run: npm run test:coverage
      
    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info

  # ================================
  # ğŸ—ï¸ Build Windows
  # ================================
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    needs: [security-audit, typescript-validation]
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ§¹ Sanitize package.json (BOM protection)
      run: node tools/sanitize-package-json.cjs
      
    - name: ğŸ”§ Build Renderer
      run: npm run build:renderer
      
    - name: ğŸ”§ Build Main
      run: npm run build:main
      
    - name: ğŸ“¦ Package Electron (Portable)
      run: npm run build:portable
      
    - name: ğŸ” Generate SHA256
      run: |
        $hash = (Get-FileHash dist\*.exe -Algorithm SHA256).Hash
        echo "SHA256: $hash" | Tee-Object -FilePath dist\SHA256SUMS
        
    - name: ğŸ§ª Red Team Tests
      run: node test-red-team-complete.mjs
      
    - name: âœ… Go/No-Go Checklist
      run: node checklist-go-nogo.mjs
      
    - name: ğŸ“¤ Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: usb-video-vault-windows
        path: |
          dist/*.exe
          dist/SHA256SUMS
          usb-package-final/
        retention-days: 30

  # ================================
  # ğŸ§ Build Linux
  # ================================
  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-latest
    needs: [security-audit, typescript-validation]
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ”§ Build Renderer
      run: npm run build:renderer
      
    - name: ğŸ”§ Build Main
      run: npm run build:main
      
    - name: ğŸ“¦ Package Electron (AppImage)
      run: npm run build:linux
      
    - name: ğŸ” Generate SHA256
      run: |
        sha256sum dist/*.AppImage > dist/SHA256SUMS
        
    - name: ğŸ§ª Red Team Tests
      run: node test-red-team-complete.mjs
      
    - name: âœ… Go/No-Go Checklist
      run: node checklist-go-nogo.mjs
      
    - name: ğŸ“¤ Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: usb-video-vault-linux
        path: |
          dist/*.AppImage
          dist/SHA256SUMS
        retention-days: 30

  # ================================
  # ğŸ­ E2E Tests (Playwright)
  # ================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ${{ matrix.os }}
    needs: [build-windows, build-linux]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ­ Install Playwright
      run: npx playwright install
      
    - name: ğŸ“¥ Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: usb-video-vault-${{ matrix.os == 'windows-latest' && 'windows' || 'linux' }}
        path: ./dist
        
    - name: ğŸ§ª E2E Tests
      run: npm run test:e2e
      
    - name: ğŸ“¤ Upload E2E Results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report-${{ matrix.os }}
        path: playwright-report/
        retention-days: 7

  # ================================
  # ğŸš€ Release Deployment
  # ================================
  deploy-release:
    name: ğŸš€ Deploy Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, e2e-tests]
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: ğŸ” Verify SHA256
      run: |
        cd usb-video-vault-windows
        sha256sum -c SHA256SUMS
        cd ../usb-video-vault-linux
        sha256sum -c SHA256SUMS
        
    - name: ğŸ“¤ Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          usb-video-vault-windows/*.exe
          usb-video-vault-windows/SHA256SUMS
          usb-video-vault-linux/*.AppImage
          usb-video-vault-linux/SHA256SUMS
        body: |
          ## ğŸ” USB Video Vault Release
          
          **Security Features:**
          - âœ… AES-256-GCM encryption
          - âœ… Ed25519 digital signatures
          - âœ… Device binding
          - âœ… Anti-tamper protection
          
          **Validation:**
          - âœ… Security audit passed
          - âœ… Red team tests passed
          - âœ… E2E tests passed
          - âœ… Go/No-Go checklist: 100%
          
          **SHA256 Checksums:**
          ```
          Windows: See SHA256SUMS
          Linux: See SHA256SUMS
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ================================
  # ğŸ“Š Notification
  # ================================
  notify-completion:
    name: ğŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, e2e-tests]
    if: always()
    
    steps:
    - name: ğŸ“¢ Build Status
      run: |
        if [ "${{ needs.build-windows.result }}" == "success" ] && [ "${{ needs.build-linux.result }}" == "success" ] && [ "${{ needs.e2e-tests.result }}" == "success" ]; then
          echo "ğŸ‰ BUILD SUCCESS: All platforms validated"
        else
          echo "âŒ BUILD FAILED: Check logs"
          exit 1
        fi