# 📋 Runbook d'exploitation - USB Video Vault

## 🔄 **Monitoring quotidien (5-10 min)**

### GitHub Actions - Surveillance continue
```powershell
# 🤖 Vérification quotidienne automatisée
# Ajouter à votre script de monitoring daily.ps1

$ErrorActionPreference = "Stop"

# 1. Vérifier les builds en échec
Write-Host "🔍 Vérification GitHub Actions..." -ForegroundColor Yellow
$apiUrl = "https://api.github.com/repos/150781/Yindo-USB-Video-Vault/actions/runs?status=failure&per_page=5"
try {
    $failedRuns = Invoke-RestMethod -Uri $apiUrl -Headers @{Accept="application/vnd.github.v3+json"}
    if ($failedRuns.workflow_runs.Count -gt 0) {
        Write-Host "❌ $($failedRuns.workflow_runs.Count) build(s) en échec détecté(s)" -ForegroundColor Red
        $failedRuns.workflow_runs | ForEach-Object {
            Write-Host "   • $($_.name): $($_.conclusion) - $($_.html_url)" -ForegroundColor Red
        }
        # Alert: envoyer notification Slack/Teams
    } else {
        Write-Host "✅ Aucun build en échec" -ForegroundColor Green
    }
} catch {
    Write-Host "⚠️ Impossible de vérifier GitHub Actions: $($_.Exception.Message)" -ForegroundColor Yellow
}

# 2. Vérifier les issues critiques
$issuesUrl = "https://api.github.com/repos/150781/Yindo-USB-Video-Vault/issues?labels=bug,critical&state=open"
try {
    $criticalIssues = Invoke-RestMethod -Uri $issuesUrl -Headers @{Accept="application/vnd.github.v3+json"}
    if ($criticalIssues.Count -gt 0) {
        Write-Host "🚨 $($criticalIssues.Count) issue(s) critique(s) ouverte(s)" -ForegroundColor Red
        $criticalIssues | ForEach-Object {
            Write-Host "   • #$($_.number): $($_.title)" -ForegroundColor Red
        }
    } else {
        Write-Host "✅ Aucune issue critique ouverte" -ForegroundColor Green
    }
} catch {
    Write-Host "⚠️ Impossible de vérifier les issues: $($_.Exception.Message)" -ForegroundColor Yellow
}

# 3. Vérifier les download stats (si public)
$releasesUrl = "https://api.github.com/repos/150781/Yindo-USB-Video-Vault/releases/latest"
try {
    $latestRelease = Invoke-RestMethod -Uri $releasesUrl -Headers @{Accept="application/vnd.github.v3+json"}
    $totalDownloads = ($latestRelease.assets | Measure-Object download_count -Sum).Sum
    Write-Host "📊 Version $($latestRelease.tag_name): $totalDownloads téléchargements" -ForegroundColor Cyan
} catch {
    Write-Host "⚠️ Impossible de récupérer stats de téléchargement" -ForegroundColor Yellow
}

Write-Host "`n✅ Monitoring quotidien terminé - $(Get-Date -Format 'yyyy-MM-dd HH:mm')" -ForegroundColor Green
```

### Support utilisateur - Tickets ouverts
```powershell
# 📧 Dashboard support quotidien
Write-Host "`n📧 Support - Tickets ouverts:" -ForegroundColor Yellow

# GitHub Issues avec label "support"
$supportUrl = "https://api.github.com/repos/150781/Yindo-USB-Video-Vault/issues?labels=support&state=open"
$supportIssues = Invoke-RestMethod -Uri $supportUrl -ErrorAction SilentlyContinue

if ($supportIssues -and $supportIssues.Count -gt 0) {
    Write-Host "📋 $($supportIssues.Count) ticket(s) de support ouvert(s):" -ForegroundColor Cyan
    $supportIssues | ForEach-Object {
        $age = (Get-Date) - [DateTime]$_.created_at
        $ageColor = if ($age.Days -gt 2) { "Red" } elseif ($age.Days -gt 1) { "Yellow" } else { "Green" }
        Write-Host "   • #$($_.number): $($_.title) ($($age.Days)j)" -ForegroundColor $ageColor
    }
} else {
    Write-Host "✅ Aucun ticket de support ouvert" -ForegroundColor Green
}
```

## 📅 **Maintenance hebdomadaire (30 min)**

### Audit de sécurité et mises à jour
```powershell
# 🛡️ Maintenance sécuritaire hebdomadaire (à planifier le dimanche)

Write-Host "=== Maintenance hebdomadaire USB Video Vault ===" -ForegroundColor Cyan
Write-Host "Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm')" -ForegroundColor Gray
Write-Host ""

# 1. Audit de sécurité complet
Write-Host "1. 🔒 Audit de sécurité:" -ForegroundColor Yellow
Set-Location "C:\Path\To\Your\Repo"  # Adapter le chemin
.\tools\security\security-audit.ps1 -Detailed -ExportReport ".\audit-weekly-$(Get-Date -Format 'yyyyMMdd').json"

$auditReport = Get-Content ".\audit-weekly-$(Get-Date -Format 'yyyyMMdd').json" | ConvertFrom-Json
Write-Host "Score de sécurité: $($auditReport.securityScore)%" -ForegroundColor $(if ($auditReport.securityScore -ge 85) { "Green" } else { "Yellow" })

if ($auditReport.summary.criticalIssues -gt 0) {
    Write-Host "🚨 $($auditReport.summary.criticalIssues) problème(s) critique(s) - ACTION IMMÉDIATE REQUISE" -ForegroundColor Red
}

# 2. Mises à jour des dépendances
Write-Host "`n2. 📦 Vérification des dépendances:" -ForegroundColor Yellow
npm outdated 2>$null | Tee-Object -Variable outdatedPackages
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Toutes les dépendances à jour" -ForegroundColor Green
} else {
    Write-Host "⚠️ Dépendances obsolètes détectées" -ForegroundColor Yellow
    Write-Host "Commande recommandée: npm update --save" -ForegroundColor Gray
}

# Audit npm des vulnérabilités
npm audit --audit-level=moderate 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Aucune vulnérabilité npm détectée" -ForegroundColor Green
} else {
    Write-Host "⚠️ Vulnérabilités npm détectées - exécutez 'npm audit fix'" -ForegroundColor Yellow
}

# 3. Vérification SmartScreen (si Windows)
Write-Host "`n3. 🛡️ Statut SmartScreen:" -ForegroundColor Yellow
# Simuler une vérification de réputation (nécessite monitoring externe)
Write-Host "📊 Vérifier manuellement la réputation SmartScreen:" -ForegroundColor Gray
Write-Host "   • https://www.microsoft.com/en-us/wdsi/filesubmission" -ForegroundColor Gray
Write-Host "   • Soumettre: USB Video Vault Setup 0.1.4.exe" -ForegroundColor Gray

# 4. Métriques d'utilisation
Write-Host "`n4. 📈 Métriques:" -ForegroundColor Yellow
# Si télémétrie disponible, sinon métriques GitHub
$releasesUrl = "https://api.github.com/repos/150781/Yindo-USB-Video-Vault/releases"
try {
    $releases = Invoke-RestMethod -Uri $releasesUrl -Headers @{Accept="application/vnd.github.v3+json"} | Select-Object -First 3
    Write-Host "📊 Téléchargements des 3 dernières releases:" -ForegroundColor Cyan
    $releases | ForEach-Object {
        $downloads = ($_.assets | Measure-Object download_count -Sum).Sum
        Write-Host "   • $($_.tag_name): $downloads téléchargements" -ForegroundColor Gray
    }
} catch {
    Write-Host "⚠️ Impossible de récupérer les métriques" -ForegroundColor Yellow
}

Write-Host "`n✅ Maintenance hebdomadaire terminée" -ForegroundColor Green
```

## 🗓️ **Maintenance mensuelle (1-2h)**

### Sécurité avancée et archivage
```powershell
# 🔐 Maintenance mensuelle - Premier dimanche du mois

Write-Host "=== Maintenance mensuelle USB Video Vault ===" -ForegroundColor Cyan
Write-Host "Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm')" -ForegroundColor Gray

# 1. Rotation des secrets GitHub
Write-Host "`n1. 🔑 Rotation des secrets (ACTION MANUELLE REQUISE):" -ForegroundColor Yellow
Write-Host "📋 Secrets à vérifier/renouveler:" -ForegroundColor Cyan
Write-Host "   • WINDOWS_CERT_PASSWORD - Certificat de signature Windows" -ForegroundColor White
Write-Host "   • MACOS_CERT_PASSWORD - Certificat de signature macOS" -ForegroundColor White
Write-Host "   • GPG_PRIVATE_KEY - Clé GPG pour signature des checksums" -ForegroundColor White
Write-Host "   • DEMO_PASSWORD - Mot de passe package démo" -ForegroundColor White
Write-Host ""
Write-Host "🎯 Actions à effectuer:" -ForegroundColor Yellow
Write-Host "   1. GitHub → Settings → Secrets and variables → Actions" -ForegroundColor Gray
Write-Host "   2. Mettre à jour les secrets arrivant à expiration" -ForegroundColor Gray
Write-Host "   3. Tester avec un build de test" -ForegroundColor Gray

# 2. Backup chiffré du certificat Authenticode
Write-Host "`n2. 💾 Backup des certificats:" -ForegroundColor Yellow
$backupDir = ".\backups\certificates\$(Get-Date -Format 'yyyy-MM')"
if (-not (Test-Path $backupDir)) {
    New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
    Write-Host "📁 Dossier backup créé: $backupDir" -ForegroundColor Green
}
Write-Host "📋 Vérifier la sauvegarde chiffrée de:" -ForegroundColor Cyan
Write-Host "   • Certificat Authenticode (.p12/.pfx)" -ForegroundColor White
Write-Host "   • Certificat macOS (.p12)" -ForegroundColor White
Write-Host "   • Clé GPG privée (export armor)" -ForegroundColor White

# 3. Purge et rotation des logs
Write-Host "`n3. 🧹 Nettoyage des logs:" -ForegroundColor Yellow
$logDirs = @(
    "$env:APPDATA\USB Video Vault\logs",
    ".\logs",
    ".\dist\logs"
)

foreach ($logDir in $logDirs) {
    if (Test-Path $logDir) {
        $oldLogs = Get-ChildItem $logDir -File | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) }
        if ($oldLogs) {
            Write-Host "🗑️ Suppression de $($oldLogs.Count) ancien(s) log(s) dans $logDir" -ForegroundColor Gray
            $oldLogs | Remove-Item -Force
        } else {
            Write-Host "✅ Aucun log ancien dans $logDir" -ForegroundColor Green
        }
    }
}

# 4. Analyse des tendances et métriques
Write-Host "`n4. 📊 Rapport mensuel:" -ForegroundColor Yellow
$reportFile = ".\reports\monthly-report-$(Get-Date -Format 'yyyy-MM').txt"
$reportDir = Split-Path $reportFile -Parent
if (-not (Test-Path $reportDir)) {
    New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
}

$report = @"
=== Rapport mensuel USB Video Vault - $(Get-Date -Format 'MMMM yyyy') ===

📊 MÉTRIQUES:
- Téléchargements totaux: [À récupérer depuis GitHub API]
- Issues fermées: [À récupérer depuis GitHub API]
- Score sécurité moyen: [À calculer depuis audits hebdomadaires]

🛡️ SÉCURITÉ:
- Certificats: [Vérifier dates d'expiration]
- Vulnérabilités: [Résumé des audits]
- Secrets: [Statut rotation]

🔧 MAINTENANCE:
- Mises à jour effectuées: [Liste]
- Problèmes résolus: [Liste]
- Actions en cours: [Liste]

📈 TENDANCES:
- Évolution téléchargements
- Types d'issues les plus fréquents
- Performance des builds

🎯 ACTIONS POUR LE MOIS PROCHAIN:
- [ ] Tâche 1
- [ ] Tâche 2
- [ ] Tâche 3
"@

$report | Out-File $reportFile -Encoding UTF8
Write-Host "📄 Rapport généré: $reportFile" -ForegroundColor Cyan

# 5. Vérification de l'état des dépôts de distribution
Write-Host "`n5. 📦 Statut distribution:" -ForegroundColor Yellow
Write-Host "📋 Vérifier manuellement:" -ForegroundColor Cyan
Write-Host "   • Winget: https://github.com/microsoft/winget-pkgs/pulls?q=USB+Video+Vault" -ForegroundColor White
Write-Host "   • Chocolatey: https://community.chocolatey.org/packages/usbvideovault" -ForegroundColor White
Write-Host "   • GitHub Releases: https://github.com/150781/Yindo-USB-Video-Vault/releases" -ForegroundColor White

Write-Host "`n✅ Maintenance mensuelle terminée" -ForegroundColor Green
Write-Host "📄 Consulter le rapport: $reportFile" -ForegroundColor Cyan
}
```

## 🚨 **Procédures d'urgence**

### Rollback rapide
```powershell
# 🔄 Procédure de rollback d'urgence
# Usage: .\emergency-rollback.ps1 -FromVersion "1.0.1" -ToVersion "1.0.0" -Reason "Critical security issue"

param(
    [Parameter(Mandatory=$true)][string]$FromVersion,
    [Parameter(Mandatory=$true)][string]$ToVersion,
    [Parameter(Mandatory=$true)][string]$Reason
)

Write-Host "🚨 ROLLBACK D'URGENCE USB Video Vault" -ForegroundColor Red
Write-Host "De: v$FromVersion → Vers: v$ToVersion" -ForegroundColor Yellow
Write-Host "Raison: $Reason" -ForegroundColor Yellow
Write-Host ""

$confirm = Read-Host "Confirmer le rollback d'urgence ? (CONFIRMER)"
if ($confirm -ne "CONFIRMER") {
    Write-Host "❌ Rollback annulé" -ForegroundColor Red
    exit 1
}

# 1. Créer une release d'urgence
Write-Host "1. 🏷️ Création release d'urgence..." -ForegroundColor Yellow
gh release create "v$ToVersion-emergency" --title "Emergency Rollback to v$ToVersion" --notes "Emergency rollback from v$FromVersion to v$ToVersion due to: $Reason"

# 2. Marquer la version problématique
Write-Host "2. ⚠️ Marquage version problématique..." -ForegroundColor Yellow
gh release edit "v$FromVersion" --prerelease

# 3. Notifications
Write-Host "3. 📢 Notifications d'urgence..." -ForegroundColor Yellow
# Webhook Slack/Teams si configuré
```

Write-Host "`n📋 Actions post-rollback requises:" -ForegroundColor Cyan
Write-Host "   • Mettre à jour Winget/Chocolatey avec la version rollback" -ForegroundColor White
Write-Host "   • Communiquer sur les canaux officiels" -ForegroundColor White
Write-Host "   • Documenter l'incident et la résolution" -ForegroundColor White
```

## 🔧 **Scripts d'automatisation**

### Planificateur Windows
```batch
@echo off
REM Tâche Windows pour monitoring quotidien
powershell.exe -ExecutionPolicy Bypass -File "C:\Path\To\USB-Video-Vault\tools\monitoring\daily-check.ps1"
```

### Cron Linux/macOS
```bash
# Monitoring quotidien - 9h00
0 9 * * * /usr/bin/powershell -File "/path/to/daily-check.ps1"

# Maintenance hebdomadaire - Dimanche 2h00
0 2 * * 0 /usr/bin/powershell -File "/path/to/weekly-maintenance.ps1"

# Maintenance mensuelle - Premier dimanche du mois 1h00
0 1 1-7 * 0 /usr/bin/powershell -File "/path/to/monthly-maintenance.ps1"
```

Cette infrastructure de monitoring vous permet de maintenir USB Video Vault de manière proactive avec une charge de travail minimale ! 🎯